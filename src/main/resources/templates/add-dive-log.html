<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Add New Dive Log - OceanDive</title>
  <link rel="stylesheet" th:href="@{/css/main.css}">
  <link rel="stylesheet" th:href="@{/css/add-dive-log.css}">
</head>
<body class="add-dive-page">
<div id="header-fragment" th:replace="~{fragments/header :: header}"></div>

<main>
  <div class="container">
    <div class="add-dive-container">
      <div class="add-dive-header">
        <h1>Add New Dive Log</h1>
        <p>Record the details of your latest diving adventure</p>
      </div>

      <div class="add-dive-content">
        <a th:href="@{/dive-log}" class="back-link">← Back to Dive Log</a>

        <!-- Error Messages -->
        <div th:if="${errorMessage}" class="alert alert-danger" th:text="${errorMessage}"></div>
        <div th:if="${successMessage}" class="alert alert-success" th:text="${successMessage}"></div>

        <!-- Preview Message -->
        <div th:if="${previewMessage}" class="alert alert-success">
          <strong>✓ </strong><span th:text="${previewMessage}"></span>
        </div>

        <form th:action="@{/dive-log/add}" th:object="${diveLog}" method="post" id="diveLogForm">

          <!-- Form Errors (inside form context) -->
          <div th:if="${#fields.hasGlobalErrors()}" class="alert alert-danger">
            <ul style="margin: 0; padding-left: 20px;">
              <li th:each="error : ${#fields.globalErrors()}" th:text="${error}">Global error</li>
            </ul>
          </div>

          <div class="form-section">
            <div class="section-title">Basic Information</div>
            <table class="form-table">
              <tr>
                <td>
                  <label class="form-label">Dive Number <span class="required">*</span></label>
                </td>
                <td>
                  <input type="number"
                         th:field="*{diveNumber}"
                         th:class="${#fields.hasErrors('diveNumber')} ? 'error' : ''"
                         min="1" required>
                  <div th:if="${#fields.hasErrors('diveNumber')}"
                       th:errors="*{diveNumber}"
                       class="error-message"></div>
                  <div class="input-note">Sequential number for your dive</div>
                </td>
              </tr>
              <tr>
                <td>
                  <label class="form-label">Location <span class="required">*</span></label>
                </td>
                <td>
                  <input type="text"
                         th:field="*{location}"
                         th:class="${#fields.hasErrors('location')} ? 'error' : ''"
                         placeholder="e.g., Red Sea, Egypt" required>
                  <div th:if="${#fields.hasErrors('location')}"
                       th:errors="*{location}"
                       class="error-message"></div>
                  <div class="input-note">Dive site or general location</div>
                </td>
              </tr>
            </table>
          </div>

          <div class="form-section">
            <div class="section-title">Time Information</div>
            <table class="form-table">
              <tr>
                <td>
                  <label class="form-label">Dive Date <span class="required">*</span></label>
                </td>
                <td>
                  <input type="date"
                         th:field="*{diveDate}"
                         th:class="${#fields.hasErrors('diveDate')} ? 'error' : ''"
                         required>
                  <div th:if="${#fields.hasErrors('diveDate')}"
                       th:errors="*{diveDate}"
                       class="error-message"></div>
                  <div class="input-note">Date of the dive</div>
                </td>
              </tr>
              <tr>
                <td>
                  <label class="form-label">Start Time <span class="required">*</span></label>
                </td>
                <td>
                  <input type="datetime-local"
                         th:field="*{startTime}"
                         th:class="${#fields.hasErrors('startTime')} ? 'error' : ''"
                         required>
                  <div th:if="${#fields.hasErrors('startTime')}"
                       th:errors="*{startTime}"
                       class="error-message"></div>
                  <div class="input-note">When you entered the water</div>
                </td>
              </tr>
              <tr>
                <td>
                  <label class="form-label">End Time <span class="required">*</span></label>
                </td>
                <td>
                  <input type="datetime-local"
                         th:field="*{endTime}"
                         th:class="${#fields.hasErrors('endTime')} ? 'error' : ''"
                         required>
                  <div th:if="${#fields.hasErrors('endTime')}"
                       th:errors="*{endTime}"
                       class="error-message"></div>
                  <div class="input-note">When you exited the water</div>
                </td>
              </tr>
              <tr>
                <td>
                  <label class="form-label">Duration (minutes)</label>
                </td>
                <td>
                  <!-- Hidden field for duration - calculated server-side -->
                  <input type="hidden" th:field="*{duration}">

                  <!-- Display calculated duration -->
                  <div class="duration-display" th:style="${diveLog.duration != null and diveLog.duration > 0} ? 'display: block;' : 'display: none;'">
                    <span th:if="${diveLog.duration != null and diveLog.duration > 0}">
                      <strong>Calculated Duration:</strong> <span th:text="${diveLog.duration}">0</span> minutes
                      <span th:if="${diveLog.duration >= 60}">
                        (<span th:text="${diveLog.formattedDuration}">0 min</span>)
                      </span>
                    </span>
                  </div>

                  <div class="input-note" th:if="${diveLog.duration == null or diveLog.duration == 0}">
                    Enter start and end times, then click "Calculate Duration" to see the dive length
                  </div>

                  <div th:if="${#fields.hasErrors('duration')}"
                       th:errors="*{duration}"
                       class="error-message"></div>
                </td>
              </tr>
            </table>
          </div>

          <div class="form-section">
            <div class="section-title">Environmental Conditions</div>
            <table class="form-table">
              <tr>
                <td>
                  <label class="form-label">Water Temperature (°C)</label>
                </td>
                <td>
                  <input type="number"
                         th:field="*{waterTemperature}"
                         th:class="${#fields.hasErrors('waterTemperature')} ? 'error' : ''"
                         step="0.1" min="-5" max="40" placeholder="e.g., 24.5">
                  <div th:if="${#fields.hasErrors('waterTemperature')}"
                       th:errors="*{waterTemperature}"
                       class="error-message"></div>
                  <div class="input-note">Optional - water temperature in Celsius</div>
                </td>
              </tr>
              <tr>
                <td>
                  <label class="form-label">Air Temperature (°C)</label>
                </td>
                <td>
                  <input type="number"
                         th:field="*{airTemperature}"
                         th:class="${#fields.hasErrors('airTemperature')} ? 'error' : ''"
                         step="0.1" min="-20" max="50" placeholder="e.g., 28.0">
                  <div th:if="${#fields.hasErrors('airTemperature')}"
                       th:errors="*{airTemperature}"
                       class="error-message"></div>
                  <div class="input-note">Optional - air temperature in Celsius</div>
                </td>
              </tr>
            </table>
          </div>

          <div class="form-section">
            <div class="section-title">Notes</div>
            <table class="form-table">
              <tr>
                <td>
                  <label class="form-label">Dive Notes (Optional)</label>
                </td>
                <td>
                  <label>
<textarea th:field="*{notes}"
          th:class="${#fields.hasErrors('notes')} ? 'error' : ''"
          maxlength="2000"
          placeholder="Describe what you saw, conditions, equipment used, etc."></textarea>
                  </label>
                  <div th:if="${#fields.hasErrors('notes')}"
                       th:errors="*{notes}"
                       class="error-message"></div>
                  <div class="char-counter">
                    <span th:text="${noteCount ?: 0}">0</span>/2000 characters
                  </div>
                </td>
              </tr>
            </table>
          </div>

          <div class="button-group">
            <button type="submit" class="button">Save</button>
            <button type="submit" th:formaction="@{/dive-log/preview}" class="button">Calculate Duration</button>
            <a th:href="@{/dive-log}" class="button">Cancel</a>
          </div>
        </form>
      </div>
    </div>
  </div>
</main>

<div id="footer-fragment" th:replace="~{fragments/footer :: footer}"></div>
</body>
</html>
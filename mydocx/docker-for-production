# Production Dockerfile

# Build stage
FROM maven:3.9.9-eclipse-temurin-21 AS build-stage

# Set the working directory
WORKDIR /app

# Copy the pom.xml and source code
COPY pom.xml ./

# If you have a Maven settings file, uncomment these lines:
# COPY settings.xml /root/.m2/settings.xml

# Copy the source code
COPY src ./src

# Build the application with production profile
RUN mvn clean package -DskipTests -Pproduction

# Runtime stage - using slim version for smaller image size
FROM openjdk:21-jdk-slim AS runtime-stage

# Create a non-root user to run the application
RUN addgroup --system --gid 1001 appuser && \
    adduser --system --uid 1001 --gid 1001 appuser

# Set the working directory
WORKDIR /app

# Copy the jar file from the build stage
COPY --from=build-stage /app/target/oceandive-0.0.1-SNAPSHOT.jar app.jar

# Change ownership of the application file to non-root user
RUN chown -R appuser:appuser /app

# Set the user for running the application
USER appuser

# Expose the application port
EXPOSE 8080

# Health check
HEALTHCHECK --interval=30s --timeout=3s --retries=3 \
  CMD curl -f http://localhost:8080/actuator/health || exit 1

# Set the entry point for the container
ENTRYPOINT ["java", "-jar", "-Dspring.profiles.active=production", "app.jar"]